---
- name: HyperRegistry | Create addon dir
  file:
    path: "{{ kube_config_dir }}/addons/hyperregistry"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: HyperRegistry | Get ingress IP and port
  include_tasks: "ingress_ip.yml"
  when: hyperregistry_ingress_nginx_ip | length == 0 or hyperregistry_ingress_nginx_port | length == 0

- name: HyperRegistry | Create values.yml
  template:
    src: "{{ item }}.j2"
    dest: "{{ kube_config_dir }}/addons/hyperregistry/{{ item }}"
  with_items: ["hr-nginx-values.yml", "oidc-integration.sh"]

- name: HyperRegistry | Check if namespace was existed
  shell: |
    {{ bin_dir }}/kubectl get namespace {{ hyperregistry_namespace }} -o json
  register: already_existed_namespace
  failed_when:
    - "already_existed_namespace.rc != 0"
    - "'not found' not in already_existed_namespace.stderr"

- name: HyperRegistry | Create namespace
  shell: |
    {{ bin_dir }}/kubectl create namespace {{ hyperregistry_namespace }}
  when:
    - "already_existed_namespace.rc != 0"
    - "'not found' in already_existed_namespace.stderr"

- name: HyperRegistry | Check if CA was existed
  shell: |
    {{ bin_dir }}/kubectl get secret ingress-tls -n {{ hyperregistry_namespace }} -o json
  register: already_existed_secret
  failed_when:
    - "already_existed_secret.rc != 0"
    - "'not found' not in already_existed_secret.stderr"

- name: HyperRegistry | Delete old CA
  shell: |
    {{ bin_dir }}/kubectl delete secret ingress-tls -n {{ hyperregistry_namespace }}
  when:
    - "already_existed_secret.rc == 0"

- name: HyperRegistry | Create secret with CA imported from ingress nginx
  shell: |
    {{ bin_dir }}/kubectl get secret ingress-tls -n {{ ingress_namespace }} -o yaml | \
      sed s/"namespace: {{ ingress_namespace }}"/"namespace: {{ hyperregistry_namespace }}"/ | \
      {{ bin_dir }}/kubectl apply -n {{ hyperregistry_namespace }} -f -
  vars:
   - ingress_namespace: "{{ ingress_nginx_namespace | default('ingress-nginx-system') }}"

- name: HyperRegistry | Check if it was installed
  shell: |
    /usr/local/bin/helm status {{ hyperregistry_release_name }} -n {{ hyperregistry_namespace }} -o json
  register: already_installed_result
  failed_when:
    - "already_installed_result.rc != 0"
    - "'not found' not in already_installed_result.stderr"

- name: HyperRegistry | Upgrade failed release
  shell: |
      /usr/local/bin/helm upgrade {{ hyperregistry_release_name }} {{ chart }} \
        --create-namespace -n {{ hyperregistry_namespace }} \
        -f {{ kube_config_dir }}/addons/hyperregistry/hr-nginx-values.yml
  vars:
    - chart: "{{ hyperregistry_download_url | regex_replace('^file://', '') }}"
  when:
    - "already_installed_result.rc == 0"
    - "'not found' not in already_installed_result.stderr"
    - "'failed' in already_installed_result.stdout | from_json | json_query('info.status')"

- name: HyperRegistry | Release HyperRegistry from helm
  shell: |
    /usr/local/bin/helm install {{ hyperregistry_release_name }} {{ chart }} \
      --create-namespace -n {{ hyperregistry_namespace }} \
      -f {{ kube_config_dir }}/addons/hyperregistry/hr-nginx-values.yml
  vars:
    - chart: "{{ hyperregistry_download_url | regex_replace('^file://', '') }}"
  when:
    - "already_installed_result.rc != 0"
    - "'not found' in already_installed_result.stderr"
